AWSTemplateFormatVersion: '2010-09-09'
Description: A stack for deploying containerized applications onto a cluster of EC2
             hosts using Elastic Container Service.

Parameters:

  Environment:
    Description: The account where the resources are being created
    Type: String
    Default: staging
    AllowedValues:
      - staging
      - prod

  Enable:
    Type: String
    Description: Enable resources
    Default: false

Conditions:

  Enabled: !Equals
    - !Ref Enable
    - true

Resources:

  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "load-balancer-sg-${Environment}"
      GroupDescription: Security group for Mlflow elastic loadbalancer
      VpcId:
        Fn::ImportValue: !Sub ec2-vpc-${Environment}:VPC
      SecurityGroupIngress:
        - IpProtocol: -1
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: Enabled
    Properties:
      Name: !Sub "load-balancer-${Environment}"
      Scheme: internet-facing
      Type: application
      Subnets:
        - Fn::ImportValue: !Sub ec2-vpc-${Environment}:PublicSubnet1
        - Fn::ImportValue: !Sub ec2-vpc-${Environment}:PublicSubnet2
      SecurityGroups:
        - Fn::ImportValue: !Sub ec2-vpc-${Environment}:HomeSecurityGroup
        - !Ref LoadBalancerSecurityGroup

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: Enabled
    Properties:
      Name: !Sub default-targetgroup-${Environment}
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 15
      HealthyThresholdCount: 5
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      TargetType: ip
      VpcId:
        Fn::ImportValue:
          !Sub ec2-vpc-${Environment}:VPC
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 30

  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: Enabled
    DependsOn:
      - TargetGroup
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref TargetGroup
          Type: forward
      LoadBalancerArn:
        Fn::ImportValue:
          !Sub ecs-loadbalancer-${Environment}:LoadBalancer
      Port: 80
      Protocol: HTTP

Outputs:

  LoadBalancer:
    Description: Load balancer
    Condition: Enabled
    Value: !Ref LoadBalancer
    Export:
      Name: !Sub ${AWS::StackName}:LoadBalancer

  LoadBalancerSecurityGroup:
    Description: The sg for the load balancer
    Value: !Ref LoadBalancerSecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}:LoadBalancerSecurityGroup

  LoadBalancerListener:
    Description: The listener for the load balancer
    Value: !Ref LoadBalancerListener
    Export:
      Name: !Sub ${AWS::StackName}:LoadBalancerListener

